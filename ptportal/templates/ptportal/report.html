<!-- Risk & Vulnerability Assessment Reporting Engine

Copyright 2022 The Risk & Vulnerability Reporting Engine Contributors, All Rights Reserved.
(see Contributors.txt for a full list of Contributors)

SPDX-License-Identifier: BSD-3-Clause

Please see additional acknowledgments (including references to third party source code, object code, documentation and other files) in the license.txt file or contact permission@sei.cmu.edu for full terms.

Created, in part, with funding and support from the United States Government. (see Acknowledgments file).

DM22-1011
 -->

{% extends 'ptportal/base.html' %}
{% block active %}#report{% endblock %}

{% block style %}
<style>
    .header {
        padding: 10px;
        background: white;
        color: black;
        font-size: 20px;
        position: relative;
        top: -15px;
        margin-left: -18px;
        margin-right: -20px;
    }
    .float-right {
		right: 50px !important;
		position: relative !important;

	}
    .col-span-5 {
        border-top:1px solid black!important;
        border-color:#1b1c1d!important;
    }
	.table-prose {
		font-size:11pt;
		color:#555555;
	}
	.figure {
		font-size:11pt;
		color:#555555;
		font-weight:bold;
		font-style:italic;
		padding:10px 0px;
	}
	.num {
		width:100px; 
		float:left; 
		padding: 0px 10px 0px 10px;
	}
	.list {
		list-style-type:square;
		font-size:11pt;
		color:#555555;
		padding:0px 0px 10px 50px;
	}
	.notblocked {
		display:inline-block;
		color:#FF7471;
	}
	.blocked {
		display:inline-block;
		color:#83E08E;
	}
	.jump li {
		font-size:11pt;
		font-weight:bold;
		color:#333333;
		padding:5px;
	}
	h1 {
		font-size:13pt;
		font-weight:bold;
		color:#333333;
		padding:0px 0px 10px 0px;
	}
	h2 {
		font-size:12pt;
		font-weight:bold;
		font-style:italic;
		color:#555555;
		padding:0px 0px 10px 0px;
	}
	p {
		font-size:11pt;
		color:#555555;
		padding:0px 0px 10px 0px;
	}
	mark{
		background-color: #B2E2F7 ;
	}
</style>
{% endblock %}

{% block content %}
{% load report_extras %}
{% load humanize %}
{% load widget_tweaks %}
{% csrf_token %}

<div style="float:left; width:80%">
	{% if report.report_type == 'RVA' or report.report_type == 'RPT' %}
	<sds-link id="executive_summary"></sds-link>
    <sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>EXECUTIVE SUMMARY</b></template>
            <h1>Overview</h1>
            <p>The assessment team conducted a {% if report.report_type == 'RPT' %}Remote Penetration Test{% else %}Risk and Vulnerability Assessment{% endif %} ({{ report.report_type }}) at the request of {{ eng_meta.customer_long_name }} ({{ eng_meta.customer_initials }}). {{ eng_meta.team_lead_name }} ({{ eng_meta.team_lead_email }}) led the assessment remotely from {{ eng_meta.ext_start_date }} to {{ eng_meta.ext_end_date }}{% if report.report_type == 'RVA' %} and on site at {{ eng_meta.customer_location }} from {{ eng_meta.int_start_date }} to {{ eng_meta.int_end_date }}{% endif %}. This report only covers the targets described within and makes no claims about the security of any system that was deemed out of scope or was not tested during this engagement.</p>
            <br>
            <h2>Significant Findings</h2>
            <p>During testing, the team identified the following significant findings:</p>
			<sds-textarea placeholder="List only significant findings in the form of high-level points (one per line)" v-model="formData.significant_findings" rows="3" :maxlength="10000"></sds-textarea>
			<br>
            <h2>Recommendations</h2>
            <p>Based on the significant findings listed above, the team recommends the following high-level actions:</p>
			<sds-textarea placeholder="List recommendations per each of the significant findings in the form of high-level points (one per line)" v-model="formData.recommendations" rows="3" :maxlength="10000"></sds-textarea>
			<br>
            <h2>Observed Strengths</h2>
            <p>In addition to the findings described throughout this report, the team also observed the following strengths pertaining to the {{ eng_meta.customer_long_name }} network and personnel:</p>
			<sds-textarea placeholder="List observed strengths in the form of high-level points (one per line)" v-model="formData.observed_strengths" rows="3" :maxlength="10000"></sds-textarea>
			<br>
            <h1>Risk Score</h1>
            <p>The team derives a risk score from each finding based on factors related to impact and likelihood. Together, these factors help determine risk from a technical standpoint and make no assumptions about specific threat actors or the business elements of risk.</p>
            <p>From the findings, a <b>Total Risk Score</b> is calculated and can be used to measure progress as findings are mitigated. In the event that a finding was mitigated during the assessment timeframe and the team was able to validate mitigation, the <b>Mitigated Risk Score</b> is used to represent the deduction of mitigated findings.</p>
            <p>Below are the calculated risk scores and a breakdown of findings by severity:</p>
            <br>
            <table width="100%">
            	<tr>
            		<td width="20%" align="center" style="color:#555555; border:1px solid #555555; padding:10px">
            			<b>Total Risk Score</b>
            			<br><br>
            			<div style="font-size:50pt">[[formData.risk_score]]</div>
            			<br><br><br>
            			<b>Mitigated Risk Score</b>
            			<br><br>
            			<div style="font-size:50pt">[[formData.mitigated_risk_score]]</div>
            		</td>
            		<td width="80%" style="border:1px solid #555555; padding:10px">
            			<apexchart height="400" width="100%" :options="riskArgs.options" :series="riskArgs.data"></apexchart>
            		</td>
            	</tr>
            </table>
            <div class="figure" align="center">Figure {{ figure_count.count }}: Risk Score and Findings Breakdown</div>
            <br>
            <p>The assessment team identified {{findings_breakdown.Critical.count | num_to_word}} (<b>{{findings_breakdown.Critical.count}}</b>) critical {% if findings_breakdown.Critical.count == 1 %}finding{% else %}findings{% endif %}, {{findings_breakdown.High.count | num_to_word}} (<b>{{findings_breakdown.High.count}}</b>) high {% if findings_breakdown.High.count == 1 %}finding{% else %}findings{% endif %}, {{findings_breakdown.Medium.count | num_to_word}} (<b>{{findings_breakdown.Medium.count}}</b>) medium {% if findings_breakdown.Medium.count == 1 %}finding{% else %}findings{% endif %}, {{findings_breakdown.Low.count | num_to_word}} (<b>{{findings_breakdown.Low.count}}</b>) low {% if findings_breakdown.Low.count == 1 %}finding{% else %}findings{% endif %}, and {{findings_breakdown.Info.count | num_to_word}} (<b>{{findings_breakdown.Info.count}}</b>) informational {% if findings_breakdown.Info.count == 1 %}finding{% else %}findings{% endif %}. The Total Risk Score for this assessment is <b>[[formData.risk_score]]</b> and the Mitigated Risk Score after deducting mitigated findings is <b>[[formData.mitigated_risk_score]]</b>.</p>
            <br>
            <h1>NIST-Based Summary</h1>
            <p>The assessment team mapped all findings to applicable National Institute of Standards and Technology (NIST) controls as described in <sds-link href="https://csrc.nist.gov/Projects/risk-management/sp800-53-controls"><b>NIST Special Publication (SP) 800-53</b></sds-link>. The figure below illustrates the relevant control families cited based on findings. Please refer to NIST SP 800-53 for a full list of control families. The Findings section of this report provides specific mappings of controls to findings and the detailed technical description for each finding. Note that some findings may be mapped to multiple applicable NIST controls.</p>
            <apexchart height="600" width="100%" :options="nistSPArgs.options" :series="nistSPArgs.data"></apexchart>
            <div class="figure" align="center">Figure {{ figure_count.increment }}: Findings Mapped to NIST Security and Privacy Controls</div>
            <br>
            <h1>NIST Cybersecurity Framework</h1>
            <p>Findings are mapped to the NIST Framework for Improving Critical Infrastructure Cybersecurity, Version 1.1, April 16, 2018, called the <sds-link href="https://www.nist.gov/cyberframework"><b>Cybersecurity Framework</b></sds-link>. The figure below illustrates the relevant functions and categories cited based on findings. Please refer to the NIST Cybersecurity Framework for a full list of functions and categories. The Findings section of this report provides specific mappings of categories to findings and the detailed technical description for each finding. Note that some findings may be mapped to multiple applicable NIST categories.</p>
            <apexchart height="500" width="100%" :options="nistFrameworkArgs.chartOptions" :series="nistFrameworkArgs.series"></apexchart>
            <div class="figure" align="center">Figure {{ figure_count.increment }}: Findings Mapped to NIST Cybersecurity Framework Categories</div>
            <br>

	</sds-section><br>
	{% endif %}

	<sds-link id="scope"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>SCOPE</b></template>
            {% if report.report_type == 'RVA' %}
            <h1>Phishing</h1>
            <div class="num">
                <sds-input v-model="formData.users_targeted" placeholder="#" :maxlength="10"></sds-input>
            </div>
            <div style="float:left; padding: 10px 0px 0px 0px"><p>users were included in the phishing campaign(s) targeting the following mail domain(s):</p></div>
            <br>
            <div style="padding:30px 0px 10px 10px"><p>{{ eng_meta.phishing_domains }}</p></div>
            {% endif %}
            {% if report.report_type == 'RPT' %}
            <h1>Open-Source Information Gathering</h1>
            <p>Open-Source Information Gathering was conducted targeting the following domain(s):</p>
            <p>{{ eng_meta.osinf_scope }}</p>
            {% endif %}
            {% if report.report_type == 'RVA' %}
            <h1>External</h1>
            {% else %}
            <h1>Network Penetration Test</h1>
            {% endif %}
            <div class="num">
                <sds-input v-model="formData.external_discovered" placeholder="#" :maxlength="20"></sds-input>
            </div>
                <div style="float:left; padding: 10px 0px 0px 0px;"><p>of</p></div>
            <div class="num">
                <sds-input v-model="formData.external_scanned" placeholder="#" :maxlength="20"></sds-input>
            </div>
            <div style="float:left; padding: 10px 0px 0px 0px"><p>scanned hosts were discovered to be live during testing of the following in-scope targets:</p></div>
            <br>
            <div style="padding:30px 0px 10px 10px"><p>{{ eng_meta.ext_scope }}</p></div>
            {% if report.report_type == 'RPT' %}
            <h1>Web Application Assessment</h1>
            <p>Web application testing was conducted targeting the following web applications:</p>
            <p>{{ eng_meta.web_app_scope }}</p>
            {% endif %}
            {% if report.report_type == 'RVA' %}
            <h1>Internal</h1>
            <div class="num">
                <sds-input v-model="formData.internal_discovered" placeholder="#" :maxlength="20"></sds-input>
            </div>
            <div style="float:left; padding: 10px 0px 0px 0px;"><p>of</p></div>
            <div class="num">
                <sds-input v-model="formData.internal_scanned" placeholder="#" :maxlength="20"></sds-input>
            </div>
            <div style="float:left; padding: 10px 0px 0px 0px"><p>scanned hosts were discovered to be live during testing of the following in-scope targets:</p></div>
            <br>
            <div style="padding:30px 0px 10px 10px"><p>{{ eng_meta.int_scope }}</p></div>
            {% endif %}
            {% if report.report_type == 'RPT' %}
            <h1>Phishing</h1>
            <p>A technical phishing assessment was conducted targeting the following mail domain(s):</p>
            <p>{{ eng_meta.phishing_domains }}</p>
            {% endif %}
	</sds-section><br>

	{% if report.report_type == 'RVA' %}
	<sds-link id="methodology"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>METHODOLOGY</b></template>
            <p>The Risk and Vulnerability Assessment consists of several phases detailed in the subsequent sections. At a high level, the {{ report.report_type }} methodology involves:</p>
            <ul class="list">
            	<li>Gathering relevant information about the target organization and its assets;</li>
            	<li>Conducting vulnerability scanning of in-scope assets;</li>
            	<li>Manually analyzing in-scope assets and collected data;</li>
            	<li>Validating findings, including chaining together multiple vulnerabilities and misconfigurations where possible, in order to elevate privileges and access, or otherwise demonstrate significant impact;</li>
            	<li>Providing actionable deliverables to the stakeholder, including an out brief, final report, and raw assessment data</li>
            </ul>
            <p>The team utilizes this methodology from different contexts, dependent on the stakeholder’s interests and accommodations, as well as the team’s ability to obtain various levels of access. The scenarios by which the team conducts testing may include:</p>
            <ul class="list">
            	<li>External to the stakeholder’s network, with no assumed access to assets or accounts other than what is accessible to the public;</li>
            	<li>Leveraging the access of a phished user in a standard phishing campaign;</li>
            	<li>Leveraging the credentials of a phished user in a credential harvesting campaign;</li>
            	<li>Internal to the stakeholder’s network, with no initial access to the domain;</li>
            	<li>Access to the domain via a low privilege account;</li>
            	<li>Access to the domain via a privileged account</li>
            </ul>
	</sds-section><br>
	{% endif %}
	{% if report.report_type == 'RPT' %}
	<sds-link id="methodology"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>METHODOLOGY</b></template>
            <p>The Remote Penetration Test consists of several phases detailed in the subsequent sections. At a high level, the {{ report.report_type }} methodology involves:</p>
            <ul class="list">
            	<li>Gathering relevant information about the target organization and its assets;</li>
            	<li>Conducting vulnerability scanning of in-scope assets;</li>
            	<li>Conducting a technical phishing assessment to evaluate the environment's susceptibility to malicious code;</li>
            	<li>Manually analyzing in-scope assets and collected data;</li>
            	<li>Validating findings, including chaining together multiple vulnerabilities and misconfigurations where possible, in order to elevate privileges and access, or otherwise demonstrate significant impact;</li>
            	<li>Providing actionable deliverables to the stakeholder, including an out brief, final report, and raw assessment data</li>
            </ul>
            <p>The team utilizes this methodology from different contexts, dependent on the stakeholder’s interests and accommodations, as well as the team’s ability to obtain various levels of access. The scenarios by which the team conducts testing may include:</p>
            <ul class="list">
            	<li>External to the stakeholder’s network, with no assumed access to assets or accounts other than what is accessible to the public;</li>
            	<li>Leveraging user credentials identified from the internet as a result of third-party data breaches;</li>
            	<li>Leveraging stakeholder-provided credentials to access specific internet-facing web applications;</li>
            	<li>Coordinating with the stakeholder to execute a technical phishing assessment, including by simulating a phished user accessing and executing malicious code;</li>
            </ul>
	</sds-section><br>
	{% endif %}
	<sds-link id="findings"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>FINDINGS</b></template>
            <p>The team identified the following findings as potentially exploitable conditions that could lead to compromise of the confidentiality, integrity, and/or availability of the tested environment. Each finding includes a description, supporting details, and recommended steps for mitigation. The {{ eng_meta.customer_long_name }} team should review the findings and recommendations for technical weaknesses, shortcomings in processes and procedures, and systemic weaknesses in overall security posture.</p>
            <p>Severity can be used to prioritize mitigation of findings. However, {{ eng_meta.customer_long_name }} is best equipped to develop a mitigation strategy based on business impact and priorities. Mitigation Status indicates whether a finding was mitigated during the assessment timeframe and is only adjusted when the team can confidently validate that the finding was mitigated.</p>
            <h1>Findings Summary</h1>
            <table class="table-prose" id="findings-summary-table">
				<thead class="text-center">
					<tr><th width="10%"></th>
					<th width="50%">Finding Name</th>
					<th width="20%">Severity</th>
					<th width="20%">Mitigation Status</th>
					</tr>
				</thead>
				{% for f in findings %}
					<tr class="text-center">
					<td>{{ forloop.counter }}</td>
					<td>{{ f.uploaded_finding_name }}</td>
					<td>{{ f.severity }}</td>
					<td>{% if f.mitigation %}Mitigated{% else %}Not Mitigated{% endif %}</td>
					</tr>
				{% endfor %}
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: Summary of Findings, Severity, and Mitigation Status</div>
			<p>See <sds-link href="#appendix_a"><b>Appendix A</b></sds-link> for the criteria used to determine severity (Critical/High/Medium/Low/Informational).</p>
            <h1>Detailed Findings</h1>
            {% for f in findings %}
            	<table class="table-prose" id="detailed-findings-table">
            		<thead class="text-center">
            		<tr>
            			<th width="15%">ID</th>
            			<th width="40%">Finding</th>
            			<th width="15%">Severity</th>
            			<th width="15%">Location</th>
            			<th width="15%">Mitigation Status</th>
            		</tr>
            		</thead>
            		<tr class="text-center">
            			<td>{{ forloop.counter }}</td>
            			<td>{{ f.uploaded_finding_name }}</td>
            			<td>{{ f.severity }}</td>
            			<td>{{ f.assessment_type }}</td>
            			<td>{% if f.mitigation %}Mitigated{% else %}Not Mitigated{% endif %}</td>
            		</tr>
            		<tr><td colspan="5"><b>Affected Systems</b></td></tr>
            		<tr><td colspan="5">{% if f.affected_systems.count > 0 %}{% for s in f.affected_systems.all %}{% if forloop.last %}{{ s }}{% else %}{{ s }}, {% endif %}{% endfor %}{% else %}None{% endif %}</td></tr>
            		<tr><td colspan="5"><b>Description</b></td></tr>
            		<tr><td colspan="5">{{ f.description }}</td></tr>
            		<tr><td colspan="5"><b>Recommended Mitigation</b></td></tr>
            		<tr><td colspan="5">{{ f.remediation }}</td></tr>
            		<tr><td colspan="5"><b>Relevant Screenshots</b></td></tr>
            		<tr><td colspan="5">{{ f.screenshot_description }}</td></tr>
            		<tr><td colspan="1"></td><td colspan="3" align="center"><div v-for="screenshot in findingArgs.screenshots"><ul v-if="screenshot.finding === '{{f}}'"><img :src="[[screenshot.imgURL]]"><p class="figure">[[screenshot.caption]]</p><br></ul></div></td></tr>
            		<tr><td colspan="5"><b>Security Reference (FCRM, NIST, etc.)</b></td><td colspan="1"></td></tr>
            		<tr><td colspan="5">{% if f.KEV.count > 0 %}<p>This finding is a <sds-link href="#kevs"><b>Known Exploited Vulnerability</b></sds-link>.</p>{% endif %}<p>NIST 800-53: {% if f.finding.NIST_800_53 %}{{ f.finding.NIST_800_53 }}{% else %}N/A{% endif %}</p><p>NIST Cybersecurity Framework: {% if f.finding.NIST_CSF %}{{ f.finding.NIST_CSF }}{% else %}N/A{% endif %}</p></td></tr>
            	</table>
            {% endfor %}
            {% if report.report_type == 'RVA' or report.report_type == 'RPT' %}
			<h1>General Recommendations</h1>
				<p>To support the team’s goal of helping stakeholders improve their security posture, the assessment team identified general recommendations based on the Center for Internet Security’s Critical Infrastructure Security (CIS) controls for mitigating the risks discovered. The table below represents a high-level summary of prioritized recommended remediations and the associated findings. As always, {{ eng_meta.customer_long_name }} has a much deeper understanding of its business and technical environment standards that should determine the balance of implementation.</p>
				<table class="table-prose" id="cis-csc-table">
					<thead class="text-center">
						<tr><th width="10%">ID</th>
						<th width="65%">Controls</th>
						<th width="25%">Finding ID</th>
						</tr>
					</thead>
					{% for c in cis_csc %}
						<tr class="text-center">
							<td>{{ c.CIS_ID }}</td>
							<td>{{ c.name }}</td>
							<td>{{ c.finding_ids }}</td>
						</tr>
					{% endfor %}
				</table>
				<div class="figure" align="center">Table {{ table_count.count }}: Recommendations Based on CIS Controls</div>
				<br>
			{% endif %}
            <!--<sds-link id="kevs"></sds-link><h1>Known Exploited Vulnerabilities</h1>
            <p>The <sds-link href="https://www.cisa.gov/known-exploited-vulnerabilities-catalog"><b>Known Exploited Vulnerability (KEV) Catalog</b></sds-link> maintained by CISA provides a means to track vulnerabilities that are actively being exploited in the wild. Since KEVs have a high likelihood of being exploited based on the threat landscape, there is significant risk to environments containing these vulnerabilities. The list below provides a mapping of findings to KEVs. In some cases, a KEV may have been detected through vulnerability scanning, but does not necessarily have a corresponding finding if the team was unable to validate it.</p>
            <p>In addition to the CVE links provided below, the Nessus reports that were provided by the team should be referenced for details regarding the vulnerability, affected systems, and recommendations. The vulnerable assets should be investigated further to determine if mitigation is necessary.</p>
            <table class="table-prose" id="kevs-table">
				<thead class="text-center">
					<tr><th width="10%">CVE</th>
					<th width="15%">Vendor</th>
					<th width="15%">Product</th>
					<th width="35%">Vulnerability</th>
					<th width="25">Finding(s)</th>
					</tr>
				</thead>
				{% for k in kevs %}
					<tr class="text-center">
					<td>{{ k.cve_id }}</td>
					<td>{{ k.vendor_project }}</td>
					<td>{{ k.product }}</td>
					<td>{{ k.vulnerability_name }}</td>
					<td>{% for f in findings %}{% if k in f.KEV.all %}{{ f.uploaded_finding_name }}<br>{% endif %}{% endfor %}</td>
					</tr>
				{% endfor %}
            </table>
            <div class="figure" align="center">Table {{ table_count.increment }}: Known Exploited Vulnerability Mappings</div>-->
       	{% if report.report_type == 'RVA' %}
            {% if ransomware %}
            <h1>Ransomware Susceptibility</h1>
            <p>Ransomware is malicious software that encrypts files on infected hosts. In order to decrypt affected files, users or organizations are instructed to pay a ransom. Infection occurs via manual or automated deployment after an attacker has compromised a host. The impact of mass infection can be severe including lost revenue, lost data, diminished reputation, and various costs associated with incident response and recovery.</p>
            <p>During a ransomware simulation, the team found that endpoints in the {{ eng_meta.customer_long_name }} network are vulnerable to {{ ransomware_scenarios.vuln }} out of the {{ ransomware_scenarios.total }} ransomware scenarios tested. Details of the ransomware simulation can be found in the corresponding report provided with the scan reports and raw data. Additionally, in coordination with the {{ eng_meta.customer_long_name }} point-of-contact, the team identified the following detection and response results:</p>
            <ul class="list">
            	{% for r in ransomware %}
            		{% if not r.disabled and 'detected by security software' in r.description %}<li>{% if r.trigger == "Y" %}Ransomware activity was detected by security software within {{ r.time_end | timeuntil:r.time_start }}.{% else %}Ransomware activity was <b>not</b> detected by security software.{% endif %}</li>{% endif %}
            		{% if not r.disabled and 'prevented by security software' in r.description %}<li>{% if r.trigger == "Y" %}Ransomware activity was prevented by security software within {{ r.time_end | timeuntil:r.time_start }}.{% else %}Ransomware activity was <b>not</b> prevented by security software.{% endif %}</li>{% endif %}
            		{% if not r.disabled and 'detected by security and/or IT personnel' in r.description %}<li>{% if r.trigger == "Y" %}Ransomware activity was detected by security and/or IT personnel within {{ r.time_end | timeuntil:r.time_start }}.{% else %}Ransomware activity was <b>not</b> detected by security and/or IT personnel.{% endif %}</li>{% endif %}
            		{% if not r.disabled and 'reported by end users' in r.description %}<li>{% if r.trigger == "Y" %}Ransomware activity was reported by end users within {{ r.time_end | timeuntil:r.time_start }}.{% else %}Ransomware activity was <b>not</b> reported by end users.{% endif %}</li>{% endif %}
            	{% endfor %}
            </ul>
            <p>In addition to the recommended mitigations provided throughout the Findings section of this report, the team recommends taking the proactive actions listed in the Ransomware Prevention Best Practices section of the <sds-link href="https://www.cisa.gov/stopransomware/ransomware-guide"><b>CISA Ransomware Guide</b></sds-link>.</p>
            <p>In the event that a ransomware attack has taken place, the incident should be reported to federal law enforcement (see <sds-link href="https://www.cisa.gov/stopransomware/report-ransomware-0"><b>CISA’s ransomware report page</b></sds-link>) and it is recommended to follow the steps outlined in the Ransomware Response Checklist section of the <sds-link href="https://www.cisa.gov/stopransomware/ransomware-guide"><b>CISA Ransomware Guide</b></sds-link>.</p>
            {% endif %}
            {% if data_exfil %}
            <h1>Data Exfiltration</h1>
            <p>The loss of sensitive business data often represents one of the highest risks to an enterprise. The team conducted a data exfiltration simulation, in which fabricated data formatted to look like Personally Identifiable Information (PII) was transferred from an internal network to an assessment team-controlled server outside of the network. The following results were observed when the team attempted to exfiltrate data over common protocols:</p>
            <table class="table-prose" id="data-exfil-table">
				<thead class="text-center">
					<tr><th width="30%">Data Type</th>
					<th width="19%">Exfiltration Protocol</th>
					<th width="13%">Timestamp</th>
					<th width="19%">Detection</th>
					<th width="19%">Prevention</th>
					</tr>
				</thead>
				{% for d in data_exfil %}
					<tr class="text-center">
					<td>{{ d.datatype }}</td>
					<td>{{ d.protocol }}</td>
					<td>{{ d.date_time | date:'m/d/Y h:i A' }}</td>
					<td>{% if d.detection == "D" %}<div class="blocked">&#8226;</div> Detected{% else %}<div class="notblocked">&#8226;</div> Not Detected{% endif %}</td>
					<td>{% if d.prevention == "B" %}<div class="blocked">&#8226;</div> Blocked{% else %}<div class="notblocked">&#8226;</div> Not Blocked{% endif %}</td>
					</tr>
				{% endfor %}
            </table>
            <div class="figure" align="center">Table {{ table_count.increment }}: Data Exfiltration Results</div>
            <p>In addition to the recommended mitigations provided throughout the <sds-link href="#findings"><b>Findings</b></sds-link> section pertaining to protecting sensitive data, the team recommends designing and implementing network perimeter controls to detect and prevent data exfiltration. Where possible, outbound traffic should be forced through authenticated proxy servers on the enterprise perimeter. These proxy servers can be configured to decrypt and inspect network traffic, flagging suspicious or anomalous characteristics. Additionally, perimeter controls should be configured with rules that allow or block traffic based on its destination.</p>
            {% endif %}
        {% endif %}
		{% if payloads %}
			<h1>Payload Testing Results</h1>
			<p>During payload testing with {{ eng_meta.customer_long_name }}, a manual exception {% if report.exception %}{{ report.exception }}{% else %}<b>[MISSING VALUE: WAS/WAS NOT]</b>{% endif %} necessary for the test email to reach the target inbox. {% if report.browser %}{{ report.browser }}{% else %}<b>[MISSING VALUE: BROWSER NAME]</b>{% endif %} was used to download the payloads and was deemed a primary browser used by {{ eng_meta.customer_long_name }} users.</p>
			<p>While it is good to have strong filters and configurations in place to protect users from phishing attacks, it is important to note that a determined adversary could likely circumvent mail and browser filters if an established, trusted domain was used. For this reason, all recommendations outlined in this report are important considerations for defense-in-depth.</p>
			<p>For the purpose of this testing, border protection refers to the ability to make an outbound connection from the internal network to the assessment team-controlled C2 server. If this connection can be made over a particular protocol, it is assumed that all payloads utilizing the same protocol would not be blocked at the border.</p>
			<table class="table-prose" id="payload-table">
				<thead class="text-center">
				<tr><th width="45%">Payload</th>
				<th width="13%">C2 Protocol</th>
				<th width="21%">Host Protection</th>
				<th width="21%">Border Protection</th>
				</tr>
				</thead>
				{% for p in payloads %}
					<tr class="text-center">
					<td>{{ p.payload_description }}</td>
					<td>{{ p.c2_protocol }}</td>
					<td>{% if p.host_protection == "B" %}<div class="blocked">&#8226;</div> Blocked{% else %}<div class="notblocked">&#8226;</div> Not Blocked{% endif %}</td>
					<td>{% if p.border_protection == "B" %}<div class="blocked">&#8226;</div> Blocked{% else %}<div class="notblocked">&#8226;</div> Not Blocked{% endif %}</td>
					</tr>
				{% endfor %}
            </table>
            <div class="figure" align="center">Table {{ table_count.increment }}: Payload Testing Results</div>
            <br>
        {% endif %}
		{% if campaigns %}
			<h1>Phishing Campaign Results</h1>
			{% for c in campaigns %}
				<p>{{ c.campaign_description }}</p>
				<table class="table-prose" id="campaign-table">
					<thead class="text-center">
						<tr><th colspan="2">Campaign #{{ forloop.counter }}</th></tr>
					</thead>
					<tr>
						<td width="50%">Emails Sent</td><td align="center" width="50%">{{ c.emails_sent }}</td>
					</tr>
					<tr>
						<td width="50%">Emails Successfully Delivered</td><td align="center" width="50%">{{ c.emails_delivered }}</td>
					</tr>
					<tr>
						<td width="50%">Click Rate</td><td align="center" width="50%">{{ c.click_rate | percentage }}</td>
					</tr>
					<tr>
						<td width="50%">Total Clicks</td><td align="center" width="50%">{{ c.total_clicks }}</td>
					</tr>
					<tr>
						<td width="50%">Unique Clicks</td><td align="center" width="50%">{{ c.unique_clicks }}</td>
					</tr>
					<tr>
						<td width="50%">Time to First Click (HH:MM:SS)</td><td align="center" width="50%">{{ c.time_to_first_click }}</td>
					</tr>
					<tr>
						<td width="50%">Credentials Harvested</td><td align="center" width="50%">{{ c.creds_harvested }}</td>
					</tr>
					<tr>
						<td width="50%">Users Exploited</td><td align="center" width="50%">{{ c.number_exploited }}</td>
					</tr>
					<tr>
						<td width="50%">Length of Campaign</td><td align="center" width="50%">{{ c.length_of_campaign }} Days</td>
					</tr>
				</table>
				<div class="figure" align="center">Table {{ table_count.increment }}: Phishing Campaign Results ({{ forloop.counter }})</div>
				<br>
            {% endfor %}
		{% endif %}
		{% if osinf %}
			<h1>Open-Source Information Gathering Results</h1>
			<table class="table-prose" id="breach-table">
				<thead class="text-center">
					<tr><th colspan="2">Breached Email Metrics</th></tr>
				</thead>
				<tr>
					<td width="80%">Emails Identified</td><td align="center" width="20%">{{ breach_metrics.emails_identified }}</td>
				</tr>
				<tr>
					<td width="80%">Emails Identified in Third-Party Data Breaches</td><td align="center" width="20%">{{ breach_metrics.emails_identified_tp }}</td>
				</tr>
				<tr>
					<td width="80%">Percentage of Emails Identified in Third-Party Data Breaches</td><td align="center" width="20%">{{ breach_metrics.percentage_emails | percentage }}</td>
				</tr>
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: OSINF Breached Email Metrics</div>
			<br>
			<table class="table-prose" id="breach-table">
				<thead class="text-center">
					<tr><th colspan="2">Breached Credential Metrics</th></tr>
				</thead>
				<tr>
					<td width="80%">Credentials Identified</td><td align="center" width="20%">{{ breach_metrics.creds_identified }}</td>
				</tr>
				<tr>
					<td width="80%">Unique Users With Identified Credentials</td><td align="center" width="20%">{{ breach_metrics.creds_identified_unique }}</td>
				</tr>
				<tr>
					<td width="80%">Credentials Successfully Validated</td><td align="center" width="20%">{{ breach_metrics.creds_validated }}</td>
				</tr>
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: OSINF Breached Credential Metrics</div>
			<br>
			<table class="table-prose" id="payload-table">
				<thead class="text-center">
				<tr><th width="30%">Email Address</th>
				<th width="70%">Breach Information</th>
				</tr>
				</thead>
				{% for o in osinf %}
					<tr class="text-center">
					<td>{{ o.email_address }}</td>
					<td>{{ o.breach_info }}</td>
					</tr>
				{% endfor %}
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: OSINF Breached Email Addresses</div>
		{% endif %}

	</sds-section><br>

	<sds-link id="attack_paths"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>ATTACK PATHS</b></template>
            <p>Attack paths are used to demonstrate impact by chaining together vulnerabilities and misconfigurations to achieve a significant level of access. The sections below provide a high-level overview of attack paths that the team executed during the engagement and the corresponding MITRE ATT&CK techniques that were leveraged in each attack. A detailed breakdown of each attack path can be found in the corresponding <sds-link href="#appendix_d"><b>Appendix D: Narrative</b></sds-link> section.</p>
            <div v-for="path in attackPathArgs.external">
            	<h1>External Attack Path [[path.order]]</h1>
            	<img :src="[[path.imgURL]]" align="center" onerror="this.style.display='none'">
            	<div class="figure" align="center">[[path.caption]]</div>
            	<p>The following <sds-link href="https://attack.mitre.org/"><b>MITRE ATT&CK</b></sds-link> Techniques were leveraged in this attack path:</p>
            	<ul class="list">
            		<li v-for="t in path.techniques">[[t]]</li>
            	</ul>
            	<br>
            </div>
            <div v-for="path in attackPathArgs.internal">
            	<h1>Internal Attack Path [[path.order]]</h1>
            	<img :src="[[path.imgURL]]" align="center" onerror="this.style.display='none'">
            	<div class="figure" align="center">[[path.caption]]</div>
            	<p>The following <sds-link href="https://attack.mitre.org/"><b>MITRE ATT&CK</b></sds-link> Techniques were leveraged in this attack path:</p>
            	<ul class="list">
            		<li v-for="t in path.techniques">[[t]]</li>
            	</ul>
            	<br>
            </div>
            <div v-for="path in attackPathArgs.phishing">
            	<h1>Phishing Attack Path [[path.order]]</h1>
            	<img :src="[[path.imgURL]]" align="center" onerror="this.style.display='none'">
            	<div class="figure" align="center">[[path.caption]]</div>
            	<p>The following <sds-link href="https://attack.mitre.org/"><b>MITRE ATT&CK</b></sds-link> Techniques were leveraged in this attack path:</p>
            	<ul class="list">
            		<li v-for="t in path.techniques">[[t]]</li>
            	</ul>
            	<br>
            </div>
	</sds-section><br>

	<sds-link id="appendix_a"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>APPENDIX A: SEVERITY RATING CRITERIA</b></template>
            <p>The severity selected for each finding during the {{ report.report_type }} is determined using the criteria outlined below.</p>
            <table class="table-prose" id="campaign-table">
				<thead>
					<tr>
						<th width="15%">Severity</th>
						<th width="85%">Description</th>
					</tr>
				</thead>
					<tr>
						<td>Critical</td>
						<td>Critical findings pose an immediate and severe threat to the environment due to ease of exploitation and significant impact. In most cases, critical findings are reported immediately and rapid mitigation should be considered.</td>
					</tr>
					<tr>
						<td>High</td>
						<td>High findings may be leveraged by an adversary to obtain full control over a targeted asset. This includes but is not limited to: easily exploitable vulnerabilities that lead to complete compromise of an application, system, or network; significant router/firewall/server misconfigurations; weak password configurations that lead to administrator account compromise; or any vulnerability that can be exploited using readily available tools leading to significant compromise of an asset.</td>
					</tr>
					<tr>
						<td>Medium</td>
						<td>Medium findings may be leveraged by an adversary to obtain some control over a targeted asset. This includes but is not limited to: unauthorized disclosure of sensitive customer or user account information; unauthorized read access to sensitive business information; weak anti-virus implementation/configurations; and lack of segmentation between untrusted and trusted networks.</td>
					</tr>
					<tr>
						<td>Low</td>
						<td>Low findings typically encompass items of interest that are not readily exploitable and/or do not result in compromise to confidentiality, integrity, or availability of assets. The raw data and scan reports provided by the team should be reviewed for additional findings that may have been deemed low severity but were not included in this report based on the minor risk they present. Due to time constraints, the team prioritizes higher risk findings and may not be able to validate lower severity findings.</td>
					</tr>
					<tr>
						<td>Informational</td>
						<td>Informational findings are potential weaknesses within the environment that cannot be readily exploited. These findings represent areas that should be investigated further, but do not require immediate action or mitigation.</td>
					</tr>
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: Severity Rating Descriptions</div>
	</sds-section><br>

	{% if report.report_type == 'RVA' or report.report_type == 'RPT' %}
	<sds-link id="appendix_b"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>APPENDIX B: EXTERNAL PORT MAPPING</b></template>
            <p>During external testing, the team identified the following open ports/services on {{ eng_meta.customer_long_name }}’s public-facing systems. It is recommended to review the data below, determine if any unnecessary ports/services are publicly accessible, and minimize the external attack surface where possible.</p>
            <table class="table-prose" id="campaign-table">
				<thead>
					<tr>
						<th width="25%">IP</th>
						<th width="35%">Hostname</th>
						<th width="20%">Ports</th>
						<th width="20%">Service</th>
					</tr>
				</thead>
				{% for pm in port_mapping %}
					<tr>
					<td>{{ pm.ip }}</td>
					<td>{{ pm.hostname }}</td>
					<td>{% with pm.ports|split:"," as ports %}
						{% for port in ports %}
							{{ port }}<br>
						{% endfor %}
					{% endwith %}</td>
					<td>{% with pm.services|split:"," as services %}
						{% for service in services %}
							{{ service }}<br>
						{% endfor %}
					{% endwith %}</td>
					</tr>
				{% endfor %}
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: Open Ports and Services on External Systems</div>
	</sds-section><br>
	{% endif %}

	{% if report.report_type == 'FAST' %}
	<sds-link id="appendix_b"></sds-link>
	{% else %}
	<sds-link id="appendix_c"></sds-link>
	{% endif %}
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>APPENDIX {% if report.report_type == 'FAST' %}B{% else %}C{% endif %}: NARRATIVE</b></template>
            <p>This section highlights key tools and techniques the team utilized during testing and can be used to replicate the team’s actions or better understand how a particular finding was identified. These actions should only be replicated by an experienced individual who thoroughly understands the functionality and risks of the tools and techniques.</p>
            
            <h1>External</h1>
            <div v-for="path in attackPathArgs.external">
            	<h2>Attack Path [[path.order]]</h2>
            	<p><b>Tools</b></p>
            	<ul class="list">
            		<li v-for="tool in path.tools">[[tool.name]] ([[tool.url]])</li>
            	</ul>
            	<br>
            	<div v-for="step in path.steps">
            		<p><b>Step [[step.order]]:</b> [[step.description]]</p>
            		<ul v-if="step.url">
            			<table align="center">
	            			<tr>
			            		<td width="15%"></td>
			            		<td width="70%"><img :src="[[step.url]]" align="center" onerror="this.style.display='none'" /></td>
				            	<td width="15%"></td>
				            </tr>
				            <tr>
				            	<td colspan="3"><div class="figure" align="center">[[step.caption]]</div></td>
				            </tr>
			        	</table>
			        </ul>
            		<br>
            	</div>
            </div>
            {% if report.report_type == 'RVA' %}
            <h1>Internal</h1>
            <div v-for="path in attackPathArgs.internal">
            	<h2>Attack Path [[path.order]]</h2>
            	<p><b>Tools</b></p>
            	<ul class="list">
            		<li v-for="tool in path.tools">[[tool.name]] ([[tool.url]])</li>
            	</ul>
            	<br>
            	<div v-for="step in path.steps">
            		<p><b>Step [[step.order]]:</b> [[step.description]]</p>
            		<ul v-if="step.url">
            			<table align="center">
	            			<tr>
			            		<td width="15%"></td>
			            		<td width="70%"><img :src="[[step.url]]" align="center" onerror="this.style.display='none'" /></td>
				            	<td width="15%"></td>
				            </tr>
				            <tr>
				            	<td colspan="3"><div class="figure" align="center">[[step.caption]]</div></td>
				            </tr>
			        	</table>
			        </ul>
            		<br>
            	</div>
            </div>
            {% endif %}
            <h1>Phishing</h1>
            <div v-for="path in attackPathArgs.phishing">
            	<h2>Attack Path [[path.order]]</h2>
            	<p><b>Tools</b></p>
            	<ul class="list">
            		<li v-for="tool in path.tools">[[tool.name]] ([[tool.url]])</li>
            	</ul>
            	<br>
            	<div v-for="step in path.steps">
            		<p><b>Step [[step.order]]:</b> [[step.description]]</p>
            		<ul v-if="step.url">
            			<table align="center">
	            			<tr>
			            		<td width="15%"></td>
			            		<td width="70%"><img :src="[[step.url]]" align="center" onerror="this.style.display='none'" /></td>
				            	<td width="15%"></td>
				            </tr>
				            <tr>
				            	<td colspan="3"><div class="figure" align="center">[[step.caption]]</div></td>
				            </tr>
			        	</table>
			        </ul>
            		<br>
            	</div>
            </div>

	</sds-section><br>

	{% if report.report_type == 'FAST' %}
	<sds-link id="appendix_c"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>APPENDIX C: SCOPE</b></template>
            <br>
            <table class="table-prose" id="scope-table">
				<thead>
					<tr>
						<th width="30%">Service</th>
						<th width="45%">IP Address / Hostname</th>
						<th width="25%">Dates Performed</th>
					</tr>
				</thead>
					<tr>
					<td>Web Application and Penetration Test</td>
					<td>{{ eng_meta.ext_scope }}</td>
					<td>{{ eng_meta.ext_start_date | date:"m/d/Y" }} - {{ eng_meta.ext_end_date | date:"m/d/Y" }}</td>
					</tr>
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: Scope of Testing</div>
			<br>
			<h1>Exclusions</h1>
			<table class="table-prose" id="exclusions-table">
				<thead>
					<tr>
						<th width="30%">Service</th>
						<th width="45%">IP Address / Hostname</th>
					</tr>
				</thead>
					<tr>
					<td>Web Application and Penetration Test</td>
					<td>{{ eng_meta.ext_excluded_scope }}</td>
					</tr>
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: Scope Exclusions</div>
	</sds-section><br>

	<sds-link id="appendix_d"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>APPENDIX D: EXTERNAL PORT MAPPING</b></template>
            <p>During external testing, the team identified the following open ports/services on {{ eng_meta.customer_long_name }}’s public-facing systems. It is recommended to review the data below, determine if any unnecessary ports/services are publicly accessible, and minimize the external attack surface where possible.</p>
            <table class="table-prose" id="campaign-table">
				<thead>
					<tr>
						<th width="25%">IP</th>
						<th width="35%">Hostname</th>
						<th width="20%">Ports</th>
						<th width="20%">Service</th>
					</tr>
				</thead>
				{% for pm in port_mapping %}
					<tr>
					<td>{{ pm.ip }}</td>
					<td>{{ pm.hostname }}</td>
					<td>{% with pm.ports|split:"," as ports %}
						{% for port in ports %}
							{{ port }}<br>
						{% endfor %}
					{% endwith %}</td>
					<td>{% with pm.services|split:"," as services %}
						{% for service in services %}
							{{ service }}<br>
						{% endfor %}
					{% endwith %}</td>
					</tr>
				{% endfor %}
			</table>
			<div class="figure" align="center">Table {{ table_count.increment }}: Open Ports and Services on External Systems</div>
	</sds-section><br>
	{% endif %}

	{% if report.report_type == 'RVA' %}
	<sds-link id="appendix_d"></sds-link>
	<sds-section class="col-span-5" type="accented">
        <span class="border-top border-dark"></span>
            <template #title><b>APPENDIX D: PASSWORD ANALYSIS</b></template>
            <p>The assessment team obtained the hashed passwords for all the {{ eng_meta.customer_long_name }} users during the assessment and attempted to obtain the clear text passwords represented by the hashed values. The following output shows statistical analysis of the clear text passwords recovered by the team:</p>
            <sds-textarea v-model="formData.password_analysis" rows="10" placeholder="Copy/paste output from the password analysis tool (do not include the tool banner)" :maxlength="10000"></sds-textarea>
	</sds-section><br>
	{% endif %}

</div>

<div style="float:left; width:15%; right:1%; background-color:#ffffff; padding:10px; position:absolute; border:1px solid #DDDDDD; overflow:auto; position:fixed">
	<div align="center">
		{% if eng_meta.traffic_light_protocol == 'Amber' %}
			<sds-badge variant="orange">TLP: {{ eng_meta.traffic_light_protocol }}</sds-badge>
		{% elif eng_meta.traffic_light_protocol == 'Amber+Strict' %}
			<sds-badge variant="orange">TLP: {{ eng_meta.traffic_light_protocol }}</sds-badge>
		{% elif eng_meta.traffic_light_protocol == 'Red'%}
			<sds-badge variant="red">TLP: {{ eng_meta.traffic_light_protocol }}</sds-badge>
		{% else %}
			<sds-badge>TLP: {{ eng_meta.traffic_light_protocol }}</sds-badge>
		{% endif %}
	</div>
	<br>
	<ul class="jump">
		{% if report.report_type == 'RVA' or report.report_type == 'RPT' %}
		<li><a href="#executive_summary"><img class="w-4 h-4" src="/static/icons/clipboard-list-solid.svg" style="float:left;"><div style="float:left; padding: 0px 10px">Summary</div></a></li><br>
		{% endif %}
		<li><a href="#scope"><img class="w-4 h-4" src="/static/icons/bullseye-solid.svg" style="float:left"><div style="float:left; padding: 0px 10px">Scope</div></a></li><br>
		<li><a href="#findings"><img class="w-4 h-4" src="/static/icons/magnifying-glass-plus-solid.svg" style="float:left"><div style="float:left; padding: 0px 10px">Findings</div></a></li><br>
		<li><a href="#attack_paths"><img class="w-4 h-4" src="/static/icons/diagram-project.svg" style="float:left"><div style="float:left; padding: 0px 10px">Attack Paths</div></a></li><br>
		<li><a href="#appendix_a"><img class="w-4 h-4" src="/static/icons/a-solid.svg" style="float:left"><div style="float:left; padding: 0px 10px">Appendix A</div></a></li><br>
		<li><a href="#appendix_b"><img class="w-4 h-4" src="/static/icons/b-solid.svg" style="float:left"><div style="float:left; padding: 0px 10px">Appendix B</div></a></li><br>
		<li><a href="#appendix_c"><img class="w-4 h-4" src="/static/icons/c-solid.svg" style="float:left"><div style="float:left; padding: 0px 10px">Appendix C</div></a></li><br>
		{% if report.report_type == 'RVA' or report.report_type == 'FAST' %}
		<li><a href="#appendix_d"><img class="w-4 h-4" src="/static/icons/d-solid.svg" style="float:left;"><div style="float:left; padding: 0px 10px">Appendix D</div></a></li>
		{% endif %}
	</ul>
	<br><br>
	<div align="center">
		<sds-button variant="primary" class="ml-4" @click="saveReport"><img class="w-8 h-8" src="/static/icons/floppy-disk-solid.svg" style="float:left; padding:0px 6px 0px 0px"> Save</sds-button>
		<br><br>
		{% if previously_saved %}<p>Last Updated: {{ previously_saved | naturaltime }}</p>{% endif %}
	</div>
</div>

{% endblock %}

{% block scripts %}
<script>
	function pageData(){
		pageData = {
			formData: {
				significant_findings: "{{report.significant_findings | escapejs}}",
				recommendations: "{{report.recommendations | escapejs}}",
				observed_strengths: "{{report.observed_strengths | escapejs}}",
				users_targeted: {% if report.users_targeted %}"{{report.users_targeted}}"{% else %}""{% endif %},
				external_scanned: {% if report.external_scanned %}"{{report.external_scanned}}"{% else %}""{% endif %},
				external_discovered: {% if report.external_discovered %}"{{report.external_discovered}}"{% else %}""{% endif %},
				internal_scanned: {% if report.internal_scanned %}"{{report.internal_scanned}}"{% else %}""{% endif %},
				internal_discovered: {% if report.internal_discovered %}"{{report.internal_discovered}}"{% else %}""{% endif %},
				password_analysis: "{{report.password_analysis | escapejs}}",
				risk_score: 0,
				mitigated_risk_score: 0,
			},
			findingArgs: {
				screenshots: [],
			},
			attackPathArgs: {
				phishing: [],
				external: [],
				internal: [],
			},
			riskArgs: {
				options: {
					chart: {
						type: 'bar',
						height: 400,
						animations: {
							enabled: true
						}
					},
					plotOptions: {
						bar: {
							horizontal: false,
							columnWidth: '30%',
							endingShape: 'rounded',
							distributed: true
						}
					},
					dataLabels: {
						enabled: false,
					},
					colors: ['#FF7471', '#FCBF8F', '#FFDE59', '#83E08E', '#4AA1D2'],
					stroke: {
						show: true,
						width: 2,
						colors: ['transparent']
					},
					fill: {
						opacity: 1
					},
					tooltip: {
						enabled: false
					},
					title: {
						text: ''
					},
					legend: {
						show: false
					},
					yaxis: {
						title: {
							text: ''
						},
						labels: {
      						formatter: function(val) {
        						return val.toFixed(0);
      						}
    					}
					},
					xaxis: {
						categories: ['Critical', 'High', 'Medium', 'Low', 'Informational'],
						labels: {
							rotate: 0,
							rotateAlways: false,
							offsetX: 0
						}
					}
				},
				data: [
					{
						data: ['{{findings_breakdown.Critical.count}}', '{{findings_breakdown.High.count}}', '{{findings_breakdown.Medium.count}}', '{{findings_breakdown.Low.count}}', '{{findings_breakdown.Info.count}}']
					}
				],
			},
			nistSPArgs: {
				options: {
					chart: {
						type: 'bar',
						height: 600,
						animations: {
							enabled: true
						}
					},
					noData: {
						text: undefined,
					},
					plotOptions: {
						bar: {
							horizontal: true,
							columnWidth: '50%',
							endingShape: 'rounded',
							distributed: true,
						},
					},
					dataLabels: {
						enabled: false,
					},
					colors: ['#447b9a'],
					stroke: {
						show: true,
						width: 2,
						colors: ['transparent']
					},
					fill: {
						opacity: 1
					},
					tooltip: {
						enabled: false
					},
					title: {
						text: ''
					},
					legend: {
						show: false
					},
					yaxis: {
						title: {
							text: ''
						},
					},
					xaxis: {
						title: {
							text: 'Number of Findings'
						},
						categories: ['AC', 'AT', 'AU', 'CA', 'CM', 'CP', 'IA', 'IR', 'MA', 'MP', 'PE', 'PL', 'PM', 'PS', 'PT', 'RA', 'SA', 'SC', 'SI', 'SR'],
					},
				},
				data: [
					{
						data: ['{{nist_ac}}', '{{nist_at}}', '{{nist_au}}', '{{nist_ca}}', '{{nist_cm}}', '{{nist_cp}}', '{{nist_ia}}', '{{nist_ir}}', '{{nist_ma}}', '{{nist_mp}}', '{{nist_pe}}', '{{nist_pl}}', '{{nist_pm}}', '{{nist_ps}}', '{{nist_pt}}', '{{nist_ra}}', '{{nist_sa}}', '{{nist_sc}}', '{{nist_si}}', '{{nist_sr}}']
					}
				],
			},
			nistFrameworkArgs: {
				series: [],
				chartOptions: {
					chart: {
						height: 500,
						type: 'pie',
					},
					labels: ['ID.AM','ID.GV','ID.RA','ID.SC','PR.AC','PR.AT','PR.DS','PR.IP','PR.MA','PR.PT','DE.AE','DE.CM','DE.DP','RS.MI'],
					legend: {
						show: false
					},
					dataLabels: {
						enabled: true,
						style: {
							fontSize: '16px',
							colors: ['black']
						},
						formatter(val, opts) {
							const name = opts.w.globals.labels[opts.seriesIndex]
							return [name, val.toFixed(1) + '%']
						},
						dropShadow: {
							enabled: false,
						},
					},
					plotOptions: {
						pie: {
							customScale: 0.7,
							dataLabels: {
								offset:100
							}
						}
					},
					colors: ['#f5a149', '#e86332', '#8f6da9', '#7fcde4', '#07aeb6', '#447b9a', '#acd672', '#558824', '#f9d46c', '#c2a1c0', '#84407e', '#fbbfcb', '#e35b79', "#dc4c4c"]
				},
			},
		}

		pageData.nistFrameworkArgs.series.push(parseInt("{{nist_iam}}"))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_ig}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_ira}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_isc}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_pac}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_pat}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_pds}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_pip}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_pma}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_ppt}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_dae}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_dcm}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_ddp}}'))
		pageData.nistFrameworkArgs.series.push(parseInt('{{nist_rmi}}'))
		

		total_risk = 0
		mitigated_risk = 0

		{% for finding in findings %}
			total_risk += parseInt("{{finding.risk_score}}")
			{% if finding.mitigation != True %}
				mitigated_risk += parseInt("{{finding.risk_score}}")
			{% endif %}
		{% endfor %}

		{% for screenshot in screenshots %}
     		imgURL = window.location.origin + "/media/" + "{{screenshot.file}}"
    		caption = "{{screenshot.caption}}"
    		pageData.findingArgs.screenshots.push({finding: "{{screenshot.finding}}", imgURL: imgURL, caption: caption})
    	{% endfor %}

    	{% for path in narratives_phishing %}
    		imgURL = window.location.origin + "/media/" + "{{path.file}}"
    		caption = "{{path.caption}}"

    		techniques = []
    		tools = []
    		steps = []

        	{% for technique in path.attack.all %}
            	techniques.push("{{technique.name|escapejs}}")
        	{% endfor %}

        	{% for tool in path.tools.all %}
            	tools.push({name: "{{tool.name|escapejs}}", url: "{{tool.url|escapejs}}"})
        	{% endfor %}

        	{% for step in phishing_steps %}
        		{% if step.narrative == path %}
        			screenshotURL = window.location.origin + "/media/" + "{{step.file}}"
        			steps.push({order: "{{step.order}}", description: "{{step.description|escapejs}}", url: screenshotURL, caption: "{{step.caption|escapejs}}"})
        		{% endif %}
        	{% endfor %}

    		pageData.attackPathArgs.phishing.push({order: "{{path.order}}", techniques: techniques, tools: tools, imgURL: imgURL, caption: caption, steps: steps})
    	{% endfor %}

    	{% for path in narratives_external %}
    		imgURL = window.location.origin + "/media/" + "{{path.file}}"
    		caption = "{{path.caption}}"

    		techniques = []
    		tools = []
    		steps = []

        	{% for technique in path.attack.all %}
            	techniques.push("{{technique.name}}")
        	{% endfor %}

        	{% for tool in path.tools.all %}
            	tools.push({name: "{{tool.name|escapejs}}", url: "{{tool.url|escapejs}}"})
        	{% endfor %}

        	{% for step in external_steps %}
        		{% if step.narrative == path %}
        			screenshotURL = window.location.origin + "/media/" + "{{step.file}}"
        			steps.push({order: "{{step.order}}", description: "{{step.description|escapejs}}", url: screenshotURL, caption: "{{step.caption|escapejs}}"})
        		{% endif %}
        	{% endfor %}

    		pageData.attackPathArgs.external.push({order: "{{path.order}}", techniques: techniques, tools: tools, imgURL: imgURL, caption: caption, steps: steps})
    	{% endfor %}

    	{% for path in narratives_internal %}
    		imgURL = window.location.origin + "/media/" + "{{path.file}}"
    		caption = "{{path.caption}}"

    		techniques = []
    		tools = []
    		steps = []

        	{% for technique in path.attack.all %}
            	techniques.push("{{technique.name|escapejs}}")
        	{% endfor %}

        	{% for tool in path.tools.all %}
            	tools.push({name: "{{tool.name|escapejs}}", url: "{{tool.url|escapejs}}"})
        	{% endfor %}

        	{% for step in internal_steps %}
        		{% if step.narrative == path %}
        			screenshotURL = window.location.origin + "/media/" + "{{step.file}}"
        			steps.push({order: "{{step.order}}", description: "{{step.description|escapejs}}", url: screenshotURL, caption: "{{step.caption|escapejs}}"})
        		{% endif %}
        	{% endfor %}

    		pageData.attackPathArgs.internal.push({order: "{{path.order}}", techniques: techniques, tools: tools, imgURL: imgURL, caption: caption, steps: steps})
    	{% endfor %}

		pageData.formData.risk_score = total_risk
		pageData.formData.mitigated_risk_score = mitigated_risk

		return pageData
	}

	function pageCreated() {
    	this.baseData.layoutArgs.pageTitle = "{{ object.report_type }} Report"
  	}

	function pageMethods() {
		functions = {
			saveReport: function() {
                const formData = new FormData()
      			formData.append('data', JSON.stringify(this.formData))

				fetch(window.location.href, {
					method: "POST",
					body: formData,
					credentials: "same-origin",
					headers: {"X-CSRFToken": document.getElementsByName("csrfmiddlewaretoken")[0].value}
				}).then(response => {
					if(response.ok) {
						this.displayNotification({title: "Report Saved", variant:"success", text: "Report data saved successfully. Please wait while the page refreshes..."})
						setTimeout(() => {this.redirectLink("{% url 'report'%}")}, 2000)
					}
					else {
						this.displayNotification({title: "Error Saving Data", variant:"danger", text: "Bad response received from server. Check for errors in forms and try again."})
					}
				}).catch(error => {
					this.displayNotification({text: error, title: "Error Saving Data", variant:"danger"})
				})
			},
		}
		return functions
	}


</script>
{% endblock %}